<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University AI Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .chat-container::-webkit-scrollbar,
        .chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-thumb,
        .chat-history::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 20px;
        }

        .sidebar {
            transition: transform 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            .sidebar-closed {
                transform: translateX(-100%);
            }
        }

        .typing-dot {
            animation: pulse 1.4s infinite;
        }

        /* Tom Select Styles Override for Dark Mode */
        .ts-control {
            background-color: #f3f4f6;
            /* bg-gray-100 */
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            /* border-gray-300 */
            padding: 0.60rem 0.75rem;
        }

        .dark .ts-control {
            background-color: #1f2937;
            /* dark:bg-gray-800 */
            border: 1px solid #4b5563;
            /* dark:border-gray-700 */
            color: #f9fafb;
            /* dark:text-gray-100 */
        }

        .ts-dropdown {
            background: #ffffff;
            border: 1px solid #d1d5db;
        }

        .dark .ts-dropdown {
            background: #1f2937;
            border: 1px solid #4b5563;
        }

        .dark .ts-dropdown .option {
            color: #f9fafb;
        }

        .dark .ts-dropdown .option:hover {
            background-color: #374151;
            /* dark:bg-gray-600 */
        }

        .ts-control.invalid {
            border-color: #ef4444;
            /* border-red-500 */
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div id="app" class="relative flex h-screen w-screen antialiased overflow-hidden">

        <!-- Auth Screen -->
        <div id="auth-screen" class="w-full h-full flex items-center justify-center p-4 bg-gray-200 dark:bg-gray-800">
            <div
                class="w-full max-w-md m-auto bg-white dark:bg-gray-900 rounded-2xl shadow-xl p-8 border dark:border-gray-700">
                <h1 class="text-3xl font-bold text-center mb-6 text-indigo-600 dark:text-indigo-400">University AI
                    Helper</h1>
                <div id="auth-form-container">
                    <!-- Login Form -->
                    <form id="login-form" class="space-y-6">
                        <h2 class="text-2xl font-semibold text-center text-gray-700 dark:text-gray-200">Вход</h2>
                        <div>
                            <label for="login-email"
                                class="text-sm font-medium text-gray-600 dark:text-gray-400">Email</label>
                            <input id="login-email" type="email" required
                                class="w-full p-3 mt-1 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                        </div>
                        <div>
                            <label for="login-password"
                                class="text-sm font-medium text-gray-600 dark:text-gray-400">Пароль</label>
                            <input id="login-password" type="password" required
                                class="w-full p-3 mt-1 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                        </div>
                        <p id="login-error" class="text-red-500 text-sm hidden"></p>
                        <button type="submit"
                            class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Войти</button>
                        <p class="text-center text-sm text-gray-500">Нет аккаунта? <a href="#" id="show-signup"
                                class="font-semibold text-indigo-500 hover:underline">Зарегистрироваться</a></p>
                    </form>

                    <!-- Signup Form -->
                    <form id="signup-form" class="space-y-6 hidden">
                        <h2 class="text-2xl font-semibold text-center text-gray-700 dark:text-gray-200">Регистрация</h2>
                        <div>
                            <label for="signup-email"
                                class="text-sm font-medium text-gray-600 dark:text-gray-400">Email</label>
                            <input id="signup-email" type="email" required
                                class="w-full p-3 mt-1 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                        </div>
                        <div>
                            <label for="signup-password"
                                class="text-sm font-medium text-gray-600 dark:text-gray-400">Пароль</label>
                            <input id="signup-password" type="password" required
                                class="w-full p-3 mt-1 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                        </div>
                        <div>
                            <label for="university-select"
                                class="text-sm font-medium text-gray-600 dark:text-gray-400">Университет</label>
                            <select id="university-select" placeholder="Выберите университет..." class="mt-1">
                                <!-- Options will be populated from DB -->
                            </select>
                        </div>
                        <p id="signup-error" class="text-red-500 text-sm hidden"></p>
                        <button type="submit"
                            class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Зарегистрироваться</button>
                        <p class="text-center text-sm text-gray-500">Уже есть аккаунт? <a href="#" id="show-login"
                                class="font-semibold text-indigo-500 hover:underline">Войти</a></p>
                    </form>
                </div>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chat-screen" class="hidden w-full h-full md:flex">
            <!-- Sidebar -->
            <div id="sidebar"
                class="sidebar absolute md:relative z-20 w-80 md:w-1/4 bg-gray-200 dark:bg-gray-800 p-4 flex flex-col h-full border-r dark:border-gray-700 sidebar-closed md:transform-none">
                <div class="flex-shrink-0 mb-4">
                    <button id="new-chat-btn"
                        class="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Новый чат
                    </button>
                </div>
                <div id="chat-history" class="flex-grow overflow-y-auto pr-2 space-y-2 chat-history">
                    <!-- Chat history items will be populated here -->
                </div>
                <div class="flex-shrink-0 mt-4 border-t border-gray-300 dark:border-gray-600 pt-4 space-y-2">
                    <p id="user-email" class="text-sm text-center truncate text-gray-600 dark:text-gray-400"></p>
                    <button id="logout-btn"
                        class="w-full flex items-center justify-center gap-2 bg-red-600 text-white p-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Выйти
                    </button>
                </div>
            </div>

            <!-- Main Chat Window -->
            <div class="flex-1 flex flex-col bg-white dark:bg-gray-900">
                <header
                    class="flex-shrink-0 p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h1 id="greeting-header" class="text-2xl font-bold">AI Helper</h1>
                    <div class="md:hidden">
                        <button id="menu-toggle" class="text-gray-500 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16m-7 6h7"></path>
                            </svg>
                        </button>
                    </div>
                </header>

                <div id="chat-window" class="flex-1 flex flex-col p-4 overflow-y-hidden">
                    <div id="initial-view" class="flex-1 flex flex-col justify-center items-center text-center p-4">
                        <div
                            class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/50 rounded-full flex items-center justify-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-indigo-500" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path
                                    d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                                </path>
                            </svg>
                        </div>
                        <h2 id="initial-greeting" class="text-3xl font-bold mb-2">Hello, student.</h2>
                        <p class="text-lg text-gray-500 dark:text-gray-400">Чем я могу помочь вам сегодня?</p>
                    </div>

                    <div id="chat-messages-container"
                        class="hidden flex-1 overflow-y-auto chat-container pr-2 space-y-4">
                        <!-- Messages will appear here -->
                        <div id="typing-indicator" class="hidden flex mb-4 justify-start">
                            <div class="max-w-xs lg:max-w-md p-3 rounded-2xl bg-gray-200 dark:bg-gray-700">
                                <div class="flex items-center space-x-1">
                                    <span class="w-2 h-2 bg-gray-500 rounded-full typing-dot"
                                        style="animation-delay: 0s;"></span>
                                    <span class="w-2 h-2 bg-gray-500 rounded-full typing-dot"
                                        style="animation-delay: 0.2s;"></span>
                                    <span class="w-2 h-2 bg-gray-500 rounded-full typing-dot"
                                        style="animation-delay: 0.4s;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 p-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <select id="model-selector"
                            class="bg-gray-200 dark:bg-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none">
                            <option value="subject">Subject Helper</option>
                            <option value="study">Study Helper</option>
                            <option value="mental">Mental Helper</option>
                        </select>
                        <div class="flex-1 relative">
                            <input id="message-input" type="text" placeholder="Отправьте сообщение..."
                                class="w-full p-3 pr-12 bg-gray-200 dark:bg-gray-700 border border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                            <button id="send-btn" type="button"
                                class="absolute inset-y-0 right-0 px-4 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-200 disabled:opacity-50"
                                disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="feather feather-send">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const { createClient } = supabase;

        // =================================================================================
        // НАСТРОЙКА SUPABASE: Вставьте сюда свои учетные данные из проекта Supabase
        // =================================================================================
        const SUPABASE_URL = 'https://mmgcxilliiwuskuiiwqf.supabase.co'; // Замените на URL вашего проекта
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZ2N4aWxsaWl3dXNrdWlpd3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTQ5MzMsImV4cCI6MjA3NjE3MDkzM30.JIUMJzkV08K_ziQzVSyaqvUF_REZpGOAlyH7_C8tSvw'; // Замените на ваш anon public ключ
        // =================================================================================

        const authScreen = document.getElementById('auth-screen');

        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            authScreen.innerHTML = `
                <div class="w-full max-w-lg m-auto bg-red-100 dark:bg-red-900/50 rounded-2xl shadow-xl p-8 border border-red-500 dark:border-red-700 text-center">
                    <h1 class="text-2xl font-bold text-red-800 dark:text-red-200 mb-4">Ошибка Конфигурации</h1>
                    <p class="text-red-700 dark:text-red-300">
                        Пожалуйста, откройте файл <strong>index.html</strong> и замените
                        <code>YOUR_SUPABASE_URL</code> и <code>YOUR_SUPABASE_ANON_KEY</code>
                        на настоящие ключи из вашего проекта Supabase.
                    </p>
                </div>
            `;
            authScreen.style.display = 'flex';
            throw new Error("Supabase credentials are not set. Please configure them in index.html.");
        }

        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM Элементы ---
        const chatScreen = document.getElementById('chat-screen');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const chatHistoryContainer = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const initialView = document.getElementById('initial-view');
        const newChatBtn = document.getElementById('new-chat-btn');
        const userEmailDisplay = document.getElementById('user-email');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const typingIndicator = document.getElementById('typing-indicator');
        const initialGreeting = document.getElementById('initial-greeting');
        const greetingHeader = document.getElementById('greeting-header');
        const universitySelect = document.getElementById('university-select');


        let currentUser = null;
        let activeChatId = null;
        let chatSubscription = null;
        let tomSelect = null;

        // --- Управление UI ---
        const showAuthScreen = () => {
            authScreen.style.display = 'flex';
            chatScreen.style.display = 'none';
            loadUniversities();
        };

        const showChatScreen = async (user) => {
            authScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            userEmailDisplay.textContent = user.email;

            // Fetch profile to get university name
            const { data: profile, error } = await db.from('profiles').select('universities(name)').eq('id', user.id).single();
            if (error) {
                console.error("Could not fetch user's university", error);
            } else if (profile && profile.universities) {
                const universityName = profile.universities.name;
                initialGreeting.textContent = `Hello, student of ${universityName}.`;
                greetingHeader.textContent = universityName;
            } else {
                initialGreeting.textContent = `Hello, student.`;
                greetingHeader.textContent = `AI Helper`;
            }

            loadChatHistory();
        };

        const loadUniversities = async () => {
            const { data, error } = await db.from('universities').select('id, name');
            if (error) {
                console.error('Ошибка загрузки университетов:', error);
                return;
            }

            if (tomSelect) {
                tomSelect.destroy();
            }

            universitySelect.innerHTML = '<option value="">Выберите университет...</option>'; // Clear previous and add placeholder
            data.forEach(uni => {
                const option = document.createElement('option');
                option.value = uni.id;
                option.textContent = uni.name;
                universitySelect.appendChild(option);
            });

            tomSelect = new TomSelect(universitySelect, {
                create: false,
                sortField: {
                    field: "text",
                    direction: "asc"
                }
            });
        };

        const showTypingIndicator = () => {
            typingIndicator.classList.remove('hidden');
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        };

        const hideTypingIndicator = () => {
            typingIndicator.classList.add('hidden');
        };

        const toggleSidebar = () => sidebar.classList.toggle('sidebar-closed');
        const updateSendButton = () => sendBtn.disabled = messageInput.value.trim().length === 0;

        // --- Логика Аутентификации ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.classList.add('hidden');
            const { error } = await db.auth.signInWithPassword({ email, password });
            if (error) {
                errorEl.textContent = 'Неверный email или пароль.';
                errorEl.classList.remove('hidden');
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const universityId = universitySelect.value;
            const errorEl = document.getElementById('signup-error');
            errorEl.classList.add('hidden');
            tomSelect.control.classList.remove('invalid');

            if (!universityId) {
                errorEl.textContent = 'Пожалуйста, выберите университет.';
                errorEl.classList.remove('hidden');
                tomSelect.control.classList.add('invalid');
                return;
            }

            // Sign up with university_id in metadata
            const { data, error } = await db.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        university_id: universityId
                    }
                }
            });

            if (error) {
                errorEl.textContent = 'Ошибка регистрации. Возможно, пользователь уже существует.';
                errorEl.classList.remove('hidden');
            } else {
                alert('Регистрация прошла успешно! Пожалуйста, проверьте свою почту для подтверждения.');
                // Switch back to login form after successful signup
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await db.auth.signOut();
            window.location.hash = '';
        });
        showSignup.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
        showLogin.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        menuToggle.addEventListener('click', toggleSidebar);

        // --- Логика Чата ---
        const loadChatHistory = async () => {
            if (!currentUser) return;
            chatHistoryContainer.innerHTML = '<div>Загрузка...</div>';
            const { data: chats, error } = await db.from('chats').select('id, title').eq('user_id', currentUser.id).order('created_at', { ascending: false });

            if (error) {
                console.error('Ошибка загрузки истории чатов:', error);
                chatHistoryContainer.innerHTML = '<div>Ошибка загрузки.</div>';
                return;
            }

            chatHistoryContainer.innerHTML = '';
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `flex items-center justify-between p-3 my-1 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors cursor-pointer ${chat.id === activeChatId ? 'bg-indigo-200 dark:bg-indigo-800' : ''}`;

                const chatLink = document.createElement('a');
                chatLink.href = `#${chat.id}`;
                chatLink.className = `truncate flex-1 ${chat.id === activeChatId ? 'font-semibold' : ''}`;
                chatLink.textContent = chat.title || 'Новый чат';

                const delBtn = document.createElement('button');
                delBtn.innerHTML = '✕';
                delBtn.className = 'ml-3 text-red-500 hover:text-red-700 font-bold opacity-60 hover:opacity-100';
                delBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if (!confirm('Вы уверены, что хотите удалить этот чат?')) return;

                    const { error } = await db.from('chats').delete().eq('id', chat.id);
                    if (error) {
                        console.error('Ошибка удаления чата:', error);
                    } else {
                        if (chat.id === activeChatId) {
                            window.location.hash = ''; // Go back to initial screen
                        }
                        loadChatHistory(); // Refresh list
                    }
                });

                chatItem.appendChild(chatLink);
                chatItem.appendChild(delBtn);
                chatHistoryContainer.appendChild(chatItem);
            });
        };

        const setActiveChat = async (chatId) => {
            if (chatSubscription) {
                chatSubscription.unsubscribe();
                chatSubscription = null;
            }

            activeChatId = chatId;

            // Clear previous messages, preserving the typing indicator
            while (chatMessagesContainer.firstChild && chatMessagesContainer.firstChild !== typingIndicator) {
                chatMessagesContainer.removeChild(chatMessagesContainer.firstChild);
            }

            if (chatId) {
                initialView.classList.add('hidden');
                chatMessagesContainer.classList.remove('hidden');

                const { data: chat, error } = await db.from('chats').select('messages').eq('id', chatId).single();
                if (error) { console.error('Ошибка загрузки чата:', error); return; }

                if (chat.messages) {
                    chat.messages.forEach(msg => addMessageToUI(msg.sender, msg.text));
                }

                chatSubscription = db.channel(`chat_${chatId}`)
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'chats', filter: `id=eq.${chatId}` }, payload => {
                        const updated = payload.new.messages || [];
                        const existing = Array.from(chatMessagesContainer.querySelectorAll('.message-wrapper'))
                            .map(m => m.dataset.index)
                            .filter(i => i !== undefined);

                        // добавляем только новые по индексу
                        updated.forEach((msg, i) => {
                            if (!existing.includes(String(i))) {
                                addMessageToUI(msg.sender, msg.text, i);
                            }
                        });
                    })


            } else {
                initialView.classList.remove('hidden');
                chatMessagesContainer.classList.add('hidden');
            }
            loadChatHistory();
        };

        newChatBtn.addEventListener('click', () => { window.location.hash = ''; });

        const handleSendMessage = async () => {
            const text = messageInput.value.trim();
            if (!text || !currentUser) return;

            const userMessage = { sender: 'user', text };
            addMessageToUI(userMessage.sender, userMessage.text);
            messageInput.value = '';
            updateSendButton();
            showTypingIndicator();

            try {
                let currentChatId = activeChatId;
                let existingMessages = [];

                if (!currentChatId) {
                    // Create new chat
                    const { data, error } = await db.from('chats').insert({
                        user_id: currentUser.id,
                        title: text.substring(0, 40),
                        messages: [userMessage]
                    }).select('id, messages').single();
                    if (error) throw error;

                    currentChatId = data.id;
                    existingMessages = data.messages;
                    window.location.hash = currentChatId;
                } else {
                    // Fetch latest messages to append to
                    const { data: chatData, error: fetchError } = await db.from('chats').select('messages').eq('id', currentChatId).single();
                    if (fetchError) throw fetchError;

                    existingMessages = chatData.messages || [];

                    // Update DB with user message first
                    const updatedUserMessages = [...existingMessages, userMessage];
                    const { error: updateError } = await db.from('chats').update({ messages: updatedUserMessages }).eq('id', currentChatId);
                    if (updateError) throw updateError;
                }

                // --- AI Response Simulation ---
                setTimeout(() => {
                    const aiResponse = { sender: 'ai', text: "AI response" };
                    hideTypingIndicator();
                    addMessageToUI(aiResponse.sender, aiResponse.text); // Optimistic UI update

                    // Update DB in the background with AI message
                    const finalMessages = [...existingMessages, userMessage, aiResponse];
                    db.from('chats')
                        .update({ messages: finalMessages })
                        .eq('id', currentChatId)
                        .then(({ error }) => {
                            if (error) console.error('Error saving AI response:', error);
                        });
                }, 500);

            } catch (err) {
                console.error('Ошибка отправки сообщения:', err);
                hideTypingIndicator();
                addMessageToUI('ai', 'Не удалось отправить сообщение.');
            }
        };

        sendBtn.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !sendBtn.disabled) handleSendMessage(); });
        messageInput.addEventListener('input', updateSendButton);

        const addMessageToUI = (sender, text, index = null) => {
            const messageWrapper = document.createElement('div');
            if (index !== null) messageWrapper.dataset.index = index;
            messageWrapper.className = `flex mb-4 message-wrapper ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md p-3 rounded-2xl ${sender === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100'
                }`;
            messageBubble.textContent = text;
            messageWrapper.appendChild(messageBubble);
            typingIndicator.before(messageWrapper);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        };


        const handleUrlChange = () => {
            if (currentUser) {
                const chatId = window.location.hash.substring(1);
                setActiveChat(chatId || null);
            }
        };

        window.addEventListener('hashchange', handleUrlChange);

        db.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                showChatScreen(currentUser);
                handleUrlChange();
            } else {
                currentUser = null;
                showAuthScreen();
            }
        });

    </script>
</body>

</html>